# WiFiSniffer

ESP32 ベースの WiFi プローブリクエスト収集デバイス

## 概要

WiFiSniffer は、M5Stack Stamp S3 を使用した WiFi パケットスニファーです。周囲のデバイスが発信するプローブリクエストを収集し、SHA256 でハッシュ化して SD カードに記録します。

## 主な機能

- **プローブリクエスト収集**: ESP32 のプロミスキャスモードを使用して WiFi プローブリクエストをキャプチャ
- **SHA256 フィンガープリント**: パケットペイロードの一意のハッシュを生成
- **非同期 SD 書き込み**: 循環バッファを使用してブロッキングを防ぐ高速書き込み
- **NTP 時刻同期**: 正確なタイムスタンプのためのネットワーク時刻同期
- **チャンネルホッピング**: 日本の全 14 チャンネル（1-14）を自動スキャン
- **LED インジケータ**: 動作状態の視覚的フィードバック

## ハードウェア要件

- M5Stack Stamp S3
- microSD カード
- （オプション）外部 LED
- M5Capsule が上記を内包

### ピン配置

- **SD カード**: CS=1, SCK=14, MISO=39, MOSI=12
- **内蔵 LED**: GPIO 21（WS2812B）
- **ボタン**: GPIO 0
- **外部 LED**: GPIO 43

## セットアップ

### 1. 開発環境

PlatformIO を使用します：

```bash
# ビルド
pio run

# デバイスへの書き込み
pio run --target upload

# シリアルモニタ
pio run --target monitor
```

### 2. WiFi 設定ファイル

SD カードのルートに`wifi.txt`を作成し、NTP 同期用の WiFi 設定を記述：

```
SSID名
パスワード
```

WPA2 エンタープライズの場合：

```
SSID名
ユーザー名
パスワード
```

### 3. 動作

1. 起動時にボタンを押すと NTP 時刻同期を実行
2. 自動的にプロミスキャスモードに入り、プローブリクエストの収集を開始
3. 500ms ごとにチャンネルを切り替えながらスキャン

## LED 表示

- **赤色高速点滅**: SD カードエラー
- **紫色高速点滅**: NTP エラー
- **緑色点滅**: NTP 同期中
- **青色点灯**: 記録中
- **水色点滅**: データ受信時

## 出力形式

SD カードに以下の形式の CSV ファイルを出力：

```csv
年,月,日,時,分,秒,SHA256ハッシュ,RSSI,MACアドレス,16進エンコードされたペイロード
```

ファイル名: `/{MACアドレス}_{連番}.csv`

## フィルタリング

以下のデータは記録から除外されます：

- SSID 情報（ID: 0x00）
- DS パラメータセット（ID: 0x03）
- Microsoft OUI（00:50:f2）で始まるベンダー固有データ

## 技術仕様

- **フレームワーク**: Arduino (PlatformIO)
- **言語**: C++
- **ライブラリ**:
  - M5Unified 0.1.10
  - FastLED 3.6.0
- **バッファサイズ**: 96 行 × 2048 文字
- **ウォッチドッグタイマー**: Core 0 で無効化（パケット処理中のリセット防止）

## ビルドとアップロード

```bash
# クリーンビルド
pio run --target clean

# ビルド
pio run

# アップロード＆モニタ
pio run --target upload --target monitor
```

## 注意事項

- 本デバイスは研究・教育目的でのみ使用してください
- 第三者のプライバシーに配慮し、適切な許可を得て使用してください
- 日本国内では技術基準適合証明（技適）を取得した機器を使用してください

## ライセンス

[ライセンスを追加してください]

## 参考

- [ESP32 WiFi Sniffer](https://lang-ship.com/blog/work/esp32-wifi-sniffer/)
- [M5Stack 公式ドキュメント](https://docs.m5stack.com/)
